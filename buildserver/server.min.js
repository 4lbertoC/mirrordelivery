/* http://github.com/4lbertoC/mirrordelivery */var g=process.env.PORT||3E3,h=require("http"),k=require("fs"),l=require("crypto"),m={"Content-Type":"text/html","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"X-Requested-With, Content-Type","Access-Control-Max-Age":"1800"};
k.exists("levels.json",function(n){n||k.writeFileSync("levels.json","{}");var d=JSON.parse(k.readFileSync("levels.json")),b;for(b in d)d[b].a<Date.now()&&(d[b]=void 0);h.createServer(function(a,c){console.log(a.method,a.url);if("OPTIONS"==a.method)c.writeHead(200,m),c.end("options received");else if("POST"==a.method&&"/addLevel"===a.url){var f="";a.on("data",function(a){f+=a});a.on("end",function(){try{JSON.parse(f);var a=l.createHash("md5");a.update(f);var b=a.digest("hex");console.log("Added level with hash: "+
b);d[b]={a:Date.now()+6048E5,b:f};k.writeFileSync("levels.json",JSON.stringify(d));c.writeHead(200,m);c.end("#"+b)}catch(e){console.log("Tried to add an invalid level: "+e.message),c.writeHead(400,{"Content-Type":"text/html"}),c.end("Invalid Level Information")}})}else if("GET"==a.method&&0===a.url.indexOf("/getLevel")){var e=a.url.substr(a.url.indexOf("/getLevel")+10),b;console.log("Requested level with hash "+e,!!d[e]);c.writeHead(200,m);d[e]&&(b=d[e].b);c.end(b)}else c.writeHead(400,{"Content-Type":"text/html"}),
c.end("Not Supported")}).listen(g);console.log("Listening on port "+g)});
